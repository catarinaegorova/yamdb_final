# REST API для YaMDb

Проект YaMDb собирает отзывы пользователей на произведения. Произведения делятся на категории, список которых может быть расширен. Сами произведения в YaMDb не хранятся. В каждой категории есть произведения, которым может быть присвоен жанр.
Пользователи могут ставить произведениям отзывы и оценку в диапазоне от одного до десяти, из которых формируется рейтинг произведения. На одно произведение пользователь может оставить только один отзыв.

## Команда разработки
[@NikitaKorovykovskiy](https://github.com/NikitaKorovykovskiy) (тимлид, управление пользователями (Auth и Users): система регистрации и аутентификации, права доступа, работу с токеном, систему подтверждения через e-mail)

[@Catarinaegorova](https://github.com/catarinaegorova) (категории (Categories), жанры (Genres) и произведения (Titles): модели, представления и эндпойнты для них, реализация механизма импорта данных из csv файлов)

[@SKirisyuk](https://github.com/SKirisyuk) (отзывы (Review) и комментариями (Comments): модели, представления, эндпойнты и реализация рейтинга произведений)

## Стек технологии
- Python
- Django
- Django REST Framework
- REST API
- POSTGRES
- Аутентификация по JWT-токену
- NGINX
- Docker
    
## Описание Workflow

# Workflow состоит из четырёх шагов:
tests
- Проверка кода на соответствие PEP8, автоматический запуск тестов.
Push Docker image to Docker Hub
- Сборка и публикация образа на DockerHub.
deploy
- Автоматический деплой на боевой сервер при пуше в главную ветку main.
send_massage
- Отправка уведомления в телеграм-чат.

## Запуск проекта

# 1. Клонировать репозиторий:

```sh
git clone https://github.com/catarinaegorova/yamdb_final.git
```

# 2. Добавить Action Secrets

```sh
DB_ENGINE=django.db.backends.postgresql # указываем, что работаем с postgresql
DB_NAME=postgres # имя базы данных
POSTGRES_USER=username # логин для подключения к базе данных
POSTGRES_PASSWORD=password # пароль для подключения к БД (установите свой)
DB_HOST=db # название сервиса (контейнера)
DB_PORT=5432 # порт для подключения к БД

DOCKER_PASSWORD=<пароль DockerHub>
DOCKER_USERNAME=<имя пользователя DockerHub>

USER=<username для подключения к серверу>
HOST=<IP сервера>
PASSPHRASE=<пароль для сервера, если он установлен>
SSH_KEY=<ваш SSH ключ (для получения команда: cat ~/.ssh/id_rsa)>

TELEGRAM_TO=<ID своего телеграм-аккаунта>
TELEGRAM_TOKEN=<токен вашего бота>
```

# Изменить настройки default.conf в папке infra/nginx/

```sh
server_name <server_ip_address>;
```

# 4. Подготовить сервер

Установить docker и docker-compose на сервер:

```sh
sudo apt install docker.io 
sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```
Выполнить копирование файлов docker-compose.yaml и nginx/default.conf на сервер:
```sh
scp infra/docker-compose.yaml <user>@<ip_address>:/home/<user>/docker-compose.yaml
scp infra/nginx/default.conf <user>@<ip_address>:/home/<user>/nginx/default.conf
```

## Статус Workflow

![workflow](https://github.com/catarinaegorova/yamdb_final/actions/workflows/yamdb_workflow.yml/badge.svg)

# Руководство к проекту:

## Регистрация новых пользователей
1. Пользователь отправляет **POST-запрос** на добавление нового пользователя с параметрами **email** и **username** на эндпоинт **/api/v1/auth/signup/**.
2. YaMDB отправляет письмо с кодом подтверждения (confirmation_code) на **адрес email**.
3. Пользователь отправляет **POST-запрос** с параметрами **username** и **confirmation_code** на эндпоинт **/api/v1/auth/token/**, в ответе на запрос ему приходит **token (JWT-токен)**. В результате пользователь получает токен и может работать с API проекта, отправляя этот токен с каждым запросом.
4. Для повторного получения письма с кодом подтверждения пользователь отправляет **POST-запрос** с параметрами **username** и **email** на эндпоинт **/api/v1/auth/remind/**.
5. При желании пользователь отправляет **PATCH-запрос** на эндпоинт **/api/v1/users/me/** и заполняет поля в своём профайле.
6. Если пользователя создаёт администратор, например, через **POST-запрос** на эндпоинт **api/v1/users/** — письмо с кодом также приходит к нему на почту.

## Пользовательские роли
- **Аноним** — может просматривать описания произведений, читать отзывы и комментарии.
- **Аутентифицированный пользователь (user)** — может, как и Аноним, читать всё, дополнительно он может публиковать отзывы и ставить оценку произведениям (фильмам/книгам/песенкам), может комментировать чужие отзывы; может редактировать и удалять свои отзывы и комментарии. Эта роль присваивается по умолчанию каждому новому пользователю.
- **Модератор (moderator)** — те же права, что и у Аутентифицированного пользователя плюс право удалять любые отзывы и комментарии.
- **Администратор (admin)** — полные права на управление всем контентом проекта. Может создавать и удалять произведения, категории и жанры. Может назначать роли пользователям.
- **Суперюзер Django** — обладает правами администратора (admin). Даже если изменить пользовательскую роль суперюзера — это не лишит его прав администратора. Суперюзер — всегда администратор, но администратор — не обязательно суперюзер.


Проект доступен по адресу: http://158.160.63.172/api/v1/
